# 概述

由网络和路由器组成因特网的**核心部分**，提供连通性和交换，而用户使用的主机是**边缘部分**，进行通信和资源共享。

**交换**

分为电路交换、分组交换和报文交换。

1、**电路交换**单一通信就要占用电话交换机通信资源，效率低下。

2、**分组交换**由路由器担任交换机，发送方**构造并发送分组数据**，路由器**缓存后转发分组**，由接收方**接收分组后还原报文信息**。

![](C:\Users\25798\OneDrive\Notes\image\web1.png)

![](C:\Users\25798\OneDrive\Notes\image\web2.png)

广域网WAN、局域网LAN、个域网PAN

# 性能指标

## 速率

bit比特，缩写b，代表二进制数字中的一位。Byte字节，缩写B，代表8个bit位。

1B = 8b

1KB = 1024B

1MB = 1024KB

1kb = 1000b

1Mb = 1000Kb

速率即数据的传输速率，Mbps相当于Mb/s，即一秒传输多少Mb的数据。

## 带宽

表示在单位时间内能传输的最高数据率，即最高速率，单位与速率相同。

## 吞吐量

表示单位时间通过的数据量，收到网络带宽的限制。

## 时延

发送时延、传播时延、路由器处理时延。**数据大小**和**发送带宽**决定**发送时延**，**传输距离**决定**传播时延**。

## 往返时间

RTT，代表双向交互一次所需的时间。

## 利用率

信道利用率，代表信道在百分之几的时间是被利用的。当**利用率增加**时，信道的**时延也会迅速增加**。一般利用率不会超过50%，理论这种情况下时延翻倍。

## 丢包率

指传输过程中**丢失的分组数量**与**总分组数量**的比率。

1、分组在传输过程中出现误码，被节点丢弃。

2、分组到达分组交换机时，交换机的等待队列已满，被丢弃。

在通信量大时会造成网络拥塞，**丢包率**反应了网络的**拥塞情况**。

# 网络分层模型

**OSI 网络模型**

**物理层、数据链路层、网络层、传输层、会话层、表示层、应用层**

应用层，负责给应用程序提供统一的接口； 

表示层，负责把数据转换成兼容另一个系统能识别的格式； 

会话层，负责建立、管理和终止表示层实体之间的通信会话； 

传输层，负责端到端的数据传输； 

网络层，负责数据的路由、转发、分片； 

数据链路层，负责数据的封帧和差错检测，以及 MAC 寻址； 

物理层，负责在物理网络中传输数据帧；

**TCP/IP 网络模型**

**网络接口层、网络层、传输层、应用层**

TCP/IP协议族并不包含物理层和数据链路层，因此它**不能独立完成整个计算机网络系统的功能**，必须与许多其他的协议协同工作。

应用层 支持 **HTTP**、SMTP、HTTPS 等最终用户进程 

传输层 处理主机到主机的通信（**TCP**、UDP） 

网络层 寻址和路由数据包（**IP** 协议） 

链路层 通过网络的物理电线、电缆或无线信道移动比特

**原理体系结构**

结合TCP/IP网络模型和ISO网络模型的体系结构。

物理层、数据链路层、网络层、传输层、应用层

物理层：解决信号传输比特的问题

数据链路层：解决分组在一个网络上传输的问题

网络层：解决分组在多个网络上传输(路由)的问题

传输层：解决进程之间基于网络的通信问题

应用层：解决通过应用进程的交互来实现特定网络应用的问题

数据在层级之间传输，层层封装：

HTTP报文 -> TCP头部封装 -> IP头部封装 -> 以太网帧首部和尾部封装 -> 前导码封装(视为比特流)

解码过程相反，路由器仅需解码至网络层，即可进行转发。

## 物理层

为数据链路层屏蔽了各种**传输媒体**的差异，实现了不同的传输媒体上传输数据比特流。

计算机内部的短距离传输使用**并行传输**，外部线路数据使用**串行传输**。

**同步传输**过程中，需要双方的**时钟同步**，避免时钟误差累计导致比特错位。**外同步**，再添加一条单独的时钟信号线；**内同步**，将时钟同步信号编码到发送数据中一起传输(以太网常用的**曼切斯特编码**)。

**异步传输**过程中，字节之间异步，比特之间依然要同步，要在字节的首尾添加标识。

单工(单向通信)，例如广播；半双工(双向交替通信)，例如对讲机；全双工(双向同时通信)。

## 数据链路层

数据链路层以**帧**为单位传输和处理数据。

### 封装成帧

指数据链路层给上层交付的协议数据单元**添加帧头和帧尾**使之成为帧。

以太网的MAC帧：

**目的地址6字节、源地址6字节、类型2字节**、上层数据、**FCS 4字节**

MAC帧中没有定界符，需要物理层添加**前导码**和**帧间间隔**。由于没有定界符，则对上层数据没有不含定界符的限制，可以实现**透明传输**。对于有定界符的数据进行添加**转义字符**(字符填充)实现透明传输。物理层通过比特填充实现透明传输，例如**零比特填充**，连续5个1前添加比特位0。

帧的数据部分占比越高，帧的传输效率越高，但是考虑到差错控制等因素，帧数据部分有最大长度上限，即**最大传送单元MTU**。

### 差错检测

数据在传输过程中可能会出现比特翻转，称为**比特差错**。

传输错误的比特占所传输比特总数的比率为**误码率BER**。

数据链路层需要利用**差错检测码**来检测数据是否产生了比特差错。

**奇偶检验**

添加**1位奇偶校验位**，使整个数据中1的个数为奇数(奇校验)或者偶数(偶校验)。

缺点：仅能较好的检验出1位比特差错，一般不常用。

**循环冗余校验CRC**

约定好一个**生成多项式**，常用CRC-16、CRC-32等。发送方根据多项式计算出**冗余码**，例如求余数；接收方通过计算判断是否产生了误码。

漏检率非常低，广泛用于数据链路层。

上述检错码只能检查出错误，无法纠正错误；可以使用纠错码来定位错误，但开销较大，计算机网络中较少使用。

### 可靠传输

除比特差错外，还存在分组丢失、分组失序、分组重复等传输差错。

以太网不要求数据链路层实现可靠传输，无线局域网要求数据链路层实现可靠传输。

IP向上层提供无连接、不可靠传输服务。

TCP向上层通过面向连接的可靠传输服务，UDP向上层通过无连接、不可靠传输服务。

#### 停止-等待协议SW

![](C:\Users\25798\OneDrive\Notes\image\web3.png)

![](C:\Users\25798\OneDrive\Notes\image\web4.png)

当**确认信息传输超时**，发送方超时重传后，导致接收方发送了两个对于同一条数据的确认信息。为了避免这种情况，需要给接受信息带上序号。但是数据链路层直接的信息传输一般是固定的，不容易出现这种情况，所以不需要给接受信息带上序号。

缺点：当往返时延远大于发送时延时，信道利用率非常低。

#### 回退N帧协议GBN

需要给数据进行分组编号，**发送窗口数需小于编号最大值**。发送方取**发送窗口**为每一次可以发送的个数，接收方的接收窗口只能为1。发送方连续发送发送窗口的数据，无需等待接收信息。接收方按序逐个接收数据，发送接收信息ACKn，表示了接收了n及其之前的所有分组，即**累计确认**。

当出现差错时，需要回退N帧，即发送完毕的窗口数N个数据都需要重传。同时也具有超时重传机制。所以也叫滑动窗口协议。当出现差错时，其信道利用率会低于**停止-等待协议**。

#### 选择重传协议SR

同回退N帧协议，不同之处是**接收窗口也可以大于1**，**小于等于发送窗口大小**，不需要回退N帧，**仅需要对差错的帧进行重传**，但是**不能使用累计确认**。

### 点对点协议PPP

点对点协议PPP是数据链路层上的协议，具有**封装成帧**、网络控制协议NCPs对接不同网络层、链路控制协议LCP来对接物理层的不同链路。使用**CRC**进行差错检测。**透明传输**使用字节填充和零比特填充法实现。

### 媒体接入控制MAC

用于管理**多个设备**在一个**共享的传输媒体**的协调，常用**随机接入法**，例如以太网，所有站点竞争信道传输数据，发生碰撞后传输失败。无线网络中常用静态划分信道，预先分配信道。

### MAC地址

MAC地址即在媒体接入控制时设备的标识地址。其一般固定在网卡中，也被称为硬件地址、物理地址。在单一网络中可以只使用MAC地址进行通信(不常用)。包装在**传输层首部**。

组织唯一标识符OUI 3字节，网络接口标识符 3字节，通常用16进制表示。

MAC地址全为1时，为广播地址。

移动设备采用随机MAC地址访问网络，防止位置信息暴露。

### 交换机

**集线器**和**交换机**不同，仅简单的转发比特，工作在**物理层**，可以看做是一个**总线**。

交换机工作在全双工模式，集线器只能工作在半双工模式下。

以太网**交换机**工作在**数据链路层**，通过MAC地址进行并行转发。交换机通过**帧交换表**来查询MAC地址和交换机接口之间的关系。交换机通过**自学习算法**建立帧交换表，类似ARP协议的过程。

**生成树协议STP**：为提高以太网的可靠性，通常会用冗余链路，但容易存在**网络环路**，造成网络异常。交换机会自动构建一个没有环路的**树形结构**，**去除环路**。

## 网络层

### IP地址

用于标识因特网上的主机或者路由器，前三部分为网络编号，第四部分为主机编号。

包装在**网络层首部**。在数据包转发过程中，源IP地址和目的IP地址保持不变；源MAC地址和目的MAC地址随逐个链路改变。

**IP协议**不需要建立连接，提供**不可靠传输**，设计思想需要尽可能将网络层功能简化。

### ARP协议

在ARP缓存中储存了主机IP地址和MAC地址的对应关系表，**动态ARP协议需要定时删除**，因为对应关系不是一成不变的。

1、查询缓存表中不含对应的IP地址，广播发送ARP请求报文，为MAC帧形式，获取对应IP地址的MAC地址

2、对应主机接收后将发送方的IP和MAC地址存入自己的ARP缓存表中，然后发送ARP响应报文(单播)告知自己的MAC地址

3、发送端接收响应报文，将IP地址和MAC地址存入自己的缓存表中

ARP协议涉及到MAC地址，则仅可在**同一个网络**中使用。

### IPv4

常用点分十进制表示。

![](C:\Users\25798\OneDrive\Notes\image\web5.png)

以太网数据链路层的**MTU**为**1500字节**，IP数据报大小超过后需要**分片**。

#### 分类编址

只有A类、B类和C类地址可以分配给主机或路由器的各接口。**主机号全0是网络地址**，代表该网络；**主机号全1是广播地址**，都不可以分配给主机或路由器。

**A类地址**（前8位表示网络号，最高位固定位0，后24位表示主机号）：

1、可指派地址：1.0.0.0 ~ 126.255.255.254

2、本地环回测试地址：127.0.0.1 ~ 127.255.255.254

**B类地址**（前16位表示网络号，最高位固定位10，后16位表示主机号）：

1、可指派地址：128.0.0.0 ~ 191.255.255.254

**C类地址**（前24位表示网络号，最高位固定位110，后8位表示主机号）：

1、可指派地址：192.0.0.0 ~ 223.255.255.254

D类地址：多播地址，最高位固定位1110

E类地址：保留，最高位固定位1111

#### 划分子网

将主机号部分比特位借用，作为子网号表示网络中的子网络。用**子网掩码**表示划分子网后的形式，比特1部分对应网络号和子网号，比特0部分表示主机号。地址与子网掩码的逻辑与运算就可以得到网络地址部分。

#### 无分类编址

CIDR使用斜线记法，在斜线后面写上网络前缀所占的比特数量。

### 路由

将自身IP地址和目的IP地址与子网掩码相与得到**网络地址**可以判断目标主机是否与自己处于同一个网络中。

不在同一个网络时，需要路由器将数据转发至目的网络，需要查询**路由表**对应的接口进行转发。路由器可以**隔绝广播域**，使其广播范围不至于过大。

静态路由配置可能产生**路由环路**。

开放最短路径优先OSPF采用**迪杰斯特拉算法**求最短路径来进行路由。

**NAT网络地址转换**

使用NAPT路由器可以将**不同私有IP地址**以及TCP端口号映射到**公有IP地址**的TCP端口号上，缓解IPv4不足的问题。

## 传输层

**网络层**解决了计算机网络中**主机端到主机端**的通信，而**传输层**用于解决**应用进程之间**的逻辑通信。**端口号**则是应用进程的标识。计算机上的进程标识符PID于端口号不同，仅用于计算机内部进行进程识别。

传输层提供了面向连接的**TCP协议**和无连接的**UDP协议**。

TCP仅支持单播，UDP支持单播、多播以及广播。

UDP是**面向应用报文**的，可以完整传输报文；TCP是**面向字节流**的，仅针对字节流进行传输，并不还原完整报文。

UDP提供**不可靠服务**，不对报文误码和丢失做操作，适用于IP电话、视频会议等实时应用；TCP提供**可靠服务**，以及**流量控制和拥塞控制**，不会出现传输差错，适用于文件传输等。

UDP首部仅8字节，TCP报文段首部最小20字节，最大60字节。

### 端口号

端口号用16比特标识，取值范围0 ~ 65535

默认端口号：FTP 21/20；HTTP 80；DNS 53；HTTPS 443

登记端口号：1024 ~ 49151

动态端口号：49152 ~ 65535

端口号仅用于**本机中进程标识**，不同计算机中的端口号没有关联。

### TCP传输控制

TCP是全双工通信，可以同时双向通信。实际传输过程中**流量控制**的窗口大小和**拥塞控制**取**更小者**作为**发送窗口**。

**流量控制**

利用**滑动窗口机制**，实现**对发送方的流量控制**，让发送方的发送速率不要太快，让接收方来得及接收。发送方**接收到接收信息**后才可滑动发送窗口继续发送，同时具有**超时重传机制**。

接收方在接收信息中**返回窗口值**，告知发送方调整发送窗口为其对应值。接收方可以发送**0窗口值**，发送方则不会发送数据。为防止接收方新的**窗口值信息丢失**导致发送方持续阻塞，发送方在接收0窗口值后会**定时发送非零窗口探测报文**。

**拥塞控制**

发送方维护**拥塞窗口cwnd**的状态变量，取决于网络的拥塞程度，并且**动态变化**。

1、只要网络没有出现拥塞(发生超时重传)，就增大拥塞窗口

2、出现拥塞，则减少拥塞窗口

发送方将拥塞窗口大小作为发送窗口大小。

1、维护一个慢开始门限ssthresh变量，起始发送窗口为**1**

2、当cwnd < ssthresh时，使用**慢开始算法**，每次发送成功后**发送窗口大小翻倍**

3、当cwnd > ssthresh时，使用**拥塞避免算法**，每次发送成功后**发送窗口大小加1**

4、发生**拥塞**(超时重传)时，将**ssthresh减小为原来的一半**，**发送窗口大小重置为1**

**快重传**和**快恢复**

接收方接收到**失序的报文段**后发送**重复确认**告知发送方，表示数据发生了丢失情况，并没有发生拥塞，**避免了因数据丢失造成的错误的拥塞窗口的重置**。接收方收到三次重复确认后，将对丢失的数据进行**立刻重传**，而不会等到超时。

然后接收方执行**快恢复**，将拥塞窗口和ssthresh都置为当前窗口的一半，继续进行**拥塞避免算法**。

### TCP超时重传时间

略大于加权平均往返时间RTT。出现超时重传后，超时重传时间翻倍。

### TCP连接的建立

通过**三报文握手**建立TCP连接。

使用**三报文**而不是**二报文**为了防止连接请求第一条报文**超时重传**情况，连接释放后超时的连接请求迟到，导致接收端陷入不需要的等待。

![](C:\Users\25798\OneDrive\Notes\image\web6.png)

**保活计时器**

防止建立连接后**发送端出现故障**无法主动释放连接，接收端设置一个**保活计时器**，每次接收数据将重置时间。到时后，接收端将发送探测报文，发送10个探测报文后未获得响应将主动关闭连接。

### TCP连接的释放

通过**四报文挥手**释放TCP连接。

![](C:\Users\25798\OneDrive\Notes\image\web7.png)

**时间等待状态**为了防止第四条报文丢失情况，发送端可以收到接收端的超时重传的第三条报文后重传第四条报文。

### TCP报文段的首部

![](C:\Users\25798\OneDrive\Notes\image\web8.png)

源端口(16比特)：标识发送TCP报文段的**应用进程**

目的端口(16比特)：标识接收TCP报文段的**应用进程**

序号(32比特)：支出本TCP报文传输数据的第一个字节的**序号**

确认号(32比特)：接收端期望收到对方下一个报文段的数据第一个字节的序号，同时也是对之前已收到数据的确认。

确认标志位ACK：取值为1时确认号才有效；取值为0时确认号无效。

数据偏移(4比特)：指出TCP报文段的数据部分的位置，即报文段的**首部长度**。

保留(6比特)：保留日后使用

窗口(16比特)：发送报文段一方的**接收窗口**，即流量控制。

校验和(16比特)：检查报文段的首部和数据部分。

同步标志位SYN：在TCP连接建立时用于同步序号。

终止标志位FIN：用于释放TCP连接。

复位标志位RST：用于复位TCP连接。表示TCP连接出现了异常，必须释放连接重新建立。

推送标志位PSH：表示报文段应尽快上交应用进程，不必等到接收缓存满后再交付。

紧急标志位URG：表示紧急指针生效。

紧急指针(16比特)：用于指明**紧急数据的长度**，紧急数据将插队放在发送缓存的**最前面**，剩余长度为普通数据。接收方将

选项(长度可变，最大40字节)：储存最大报文段数据长度，窗口扩大选项，时间戳，选择确认。

填充：填充首部剩余不满字节的部分。

## 应用层

### C/S方式和P2P方式

C/S方式由服务器端提供服务，客户端消费服务；通常是**服务集中型**的，服务器经常采用集群搭建的方法来满足众多客户端的请求，常见于通信软件、网站服务等。

P2P方式没有固定的请求者和提供者，**双方直接对等通信**，为**服务分散型**。常见于文件共享、即时通信、分布式存储等。可扩展性强，成本低。

### 动态主机配置协议DHCP

通过DHCP服务**自动获取主机的配置信息**，例如IP地址、子网掩码、默认网关、DNS服务器地址等。

**DHCP协议信息**在传输层以**UDP**的形式进行传输。DHCP服务器端口为UDP 67，客户端口为UDP 68。

配置过程：

1、主机客户端**广播发送**DHCP申请的**UDP报文段**，数据中携带主机的**MAC地址**和**事务ID**。

2、DHCP服务器接收报文后，查询缓存表是否有对应信息，使用**ARP协议**确保其IP地址未被占用，没有则进行默认配置。然后**广播发送**其配置信息。

3、主机客户端接收配置信息后，查看其事务ID是否与自身发送的相同，相同则**广播发送**(因为还未与服务器端进行确认)确认信息，告知服务器作为其DHCP服务器。确认信息中携带主机自身MAC地址，事务ID，租约的IP地址，提供租约的DHCP服务端IP地址。

4、DHCP服务器接收报文后，**广播发送ACK确认信息**。

5、主机收到报文后，通过ARP检测其IP地址是否被占用，未被占用则可以开始使用其IP地址，被占用则向DHCP服务器发送撤销报文。然后**重新进行申请过程**。

当主机IP地址租用期过半时，将发送请求延长租用期。若服务器端发送拒绝报文，则立刻停止使用IP地址，**重新进行申请过程**。

![](C:\Users\25798\OneDrive\Notes\image\web9.png)

**DHCP中继代理**：某一网络中没有DHCP服务器，则可以使用路由器配置DHCP服务进行中继代理，为客户端主机申请其他网络中的DHCP服务器的服务。

### 域名系统DNS

用户主机访问域名时的过程：

1、系统会检查**浏览器缓存**中是否有该域名的记录，如果有，就直接使用这个IP地址，这个过程称为**DNS缓存**。

2、如果浏览器缓存中没有找到，系统会检查操作系统缓存中是否有这个域名对应的DNS解析结果。在Windows系统中，这可以通过**hosts**文件来设置。

3、如果前两步都未找到记录，系统会向**配置的本地DNS服务器**发起请求。

4、如果本地DNS服务器没有缓存该域名的记录，它会向**根DNS服务器**请求解析。

5、根DNS服务器会返回一个负责该顶级域名的DNS服务器地址，例如*.com*、*.cn*等。

6、权限DNS服务器会查找域名与IP地址的映射关系，并将结果返回给本地DNS服务器，本地DNS服务器再将结果返回给用户的计算机。

DNS服务器中存储了域名和IP地址的对应关系。

因特网采用**层次结构的命名数**作为域名，使用**分布式的域名系统DNS**。大多数域名都在本地解析，效率很高，且分布式系统容错率高。

…… . 三级域名.二级域名.顶级域名(不区分大小写)

![](C:\Users\25798\OneDrive\Notes\image\web10.png)

![](C:\Users\25798\OneDrive\Notes\image\web11.png)

域名解析：

1、递归查询，负责IP地址的层层查询

2、迭代查询，仅返回下一次需要查询的服务器的IP地址

![](C:\Users\25798\OneDrive\Notes\image\web12.png)

为了提高DNS的查询效率，域名服务器中广泛使用了**高速缓存**。但缓存需要**定时进行删除更新**，以防域名对应关系改变。

### 文件传送协议FTP

是最常用的文件传送协议，提供交互式的访问，允许指明文件的类型和格式，允许文件具有存取权限。适用于在异构网络中任意计算机间批量传送文件。

![](C:\Users\25798\OneDrive\Notes\image\web13.png)

控制连接在会话期间一直打开，用于传输FTP相关控制命令；数据连接用于文件传输，文件传输时建立，传输结束就关闭。

### 电子邮件

电子邮件系统的构件：用户代理，邮件服务器，电子邮件所需的协议。

邮件分为：信封和内容，内容包括首部和主体，首部需要填写发送地址、摘要、传送地址、目的地址等。

传输层通过**TCP协议**来发送邮件数据，端口号25。

1、发送方的**用户代理**使用**SMTP协议**发送邮件至**邮件服务器**。

2、**邮件服务器**之间通过**SMTP协议**进行**邮件的转发**。

3、接收方的用户代理使用**POP3协议**取回邮件。

**SMTP协议**只能传送**ASCII码文本数据**。

**非ASCII码**例如中文等需要用**MIME扩展**进行转码。

### 万维网

使用统一资源定位符URL指明因特网上资源的位置。

URL通过以下四个部分组成：

协议 :// 主机 : 端口 / 路径

例如：http://www.hnust.cn:80/index.html

其中默认端口号为80，默认首页为index，可以省略不写

#### HTTP协议

定义了浏览器向万维网服务器请求的方式HTTP请求报文，以及万维网服务器把文档传回浏览器的方式HTTP响应报文。

传输层使用TCP连接。

**HTTP/1.0**使用**非持续连接方式**。浏览器每请求一个文件都要与服务器建立TCP连接，收到响应后就立即关闭连接。每请求一个文档就需要2RTT的时间。浏览器通常通过多个并行的TCP连接来同时请求多个对象，服务器负担加重。

**HTTP/1.1**采用**持续连接方式**。

1、在服务器发送响应后依然保持TCP连接，在后续针对同一服务器的服务请求继续沿用该TCP连接。

2、发送端可以在收到响应报文前发送多个请求报文，流水线方式工作，减少TCP连接中的空闲时间。

#### HTTP报文格式

![](C:\Users\25798\OneDrive\Notes\image\web14.png)

![](C:\Users\25798\OneDrive\Notes\image\web15.png)

![](C:\Users\25798\OneDrive\Notes\image\web16.png)

![](C:\Users\25798\OneDrive\Notes\image\web17.png)

![](C:\Users\25798\OneDrive\Notes\image\web18.png)

HTTP是一种**无状态的协议**，无法记录用户的信息。**Cookie**是对无状态的HTTP进行状态化的技术。服务器生成一个Cookie识别码，浏览器存储后在后续请求中加入Cookie码使得服务器可以识别出该用户。

**Web缓存**，即**代理服务器**，将请求和响应暂存到磁盘中，当**缓存命中**时，就不需要去因特网访问该资源。命中率高时可以大大降低服务访问的时延。同时为防止缓存内容与原始服务器的**数据一致性**，需要定时清理过期的缓存。

